<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mail Note UI Preview</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #2b2b2b;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: white;
      text-align: center;
    }
    .preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      justify-content: center;
      padding: 20px;
    }
    .preview-box {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .preview-box h2 {
      color: #0060df;
      margin: 0 0 15px 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .iframe-container {
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }
    .banner-preview {
      width: 600px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }
    .banner-preview .fake-email {
      padding: 20px;
      color: #333;
    }
    .banner-preview .fake-email h3 {
      margin: 0 0 10px 0;
    }
    .banner-preview .fake-email p {
      color: #666;
      line-height: 1.6;
    }
    .controls {
      text-align: center;
      margin-bottom: 20px;
    }
    .controls button {
      background: #0060df;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 0 5px;
      font-size: 14px;
    }
    .controls button:hover {
      background: #003eaa;
    }
    .log-panel {
      background: #1a1a1a;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .log-panel h3 {
      color: #0060df;
      margin: 0 0 10px 0;
      font-size: 12px;
      text-transform: uppercase;
    }
    #log-output {
      background: #0d0d0d;
      border-radius: 4px;
      padding: 10px;
      color: #00ff00;
      font-family: monospace;
      font-size: 12px;
      max-height: 150px;
      overflow-y: auto;
    }
    .log-entry {
      margin-bottom: 4px;
      border-bottom: 1px solid #333;
      padding-bottom: 4px;
    }
  </style>
</head>
<body>
  <h1>üìù Mail Note - UI Preview</h1>
  
  <div class="controls">
    <button onclick="toggleBanner()">Toggle Banner</button>
    <button onclick="changeNote()">Change Note Text</button>
    <button onclick="clearLog()">Clear Log</button>
    <button onclick="reloadFrames()">Reload Frames</button>
  </div>

  <div class="preview-container">
    <!-- Add Note Popup -->
    <div class="preview-box">
      <h2>Add Note Popup</h2>
      <div class="iframe-container">
        <iframe id="add-note-frame" src="popup/add-note.html?email=john.doe@example.com&author=John Doe <john.doe@example.com>" width="450" height="450" frameborder="0"></iframe>
      </div>
    </div>

    <!-- View Note Popup -->
    <div class="preview-box">
      <h2>View Note Popup (Toolbar)</h2>
      <div class="iframe-container">
        <iframe id="view-note-frame" src="popup/view-note.html" width="320" height="200" frameborder="0"></iframe>
      </div>
    </div>

    <!-- Banner Preview -->
    <div class="preview-box">
      <h2>Email Banner Preview</h2>
      <div class="banner-preview">
        <div id="banner-container"></div>
        <div class="fake-email">
          <h3>Re: Project Update</h3>
          <p>Hi team,</p>
          <p>Just wanted to follow up on the project status. Please review the attached documents and let me know if you have any questions.</p>
          <p>Best regards,<br>John</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Log Panel -->
  <div class="log-panel">
    <h3>üìã API Call Log</h3>
    <div id="log-output"></div>
  </div>

  <script>
    // NEW: Notes now stored with pattern matching
    const mockNotes = {
      'note_1': {
        pattern: 'john.doe@example.com',
        matchType: 'exact',
        note: 'Important client - always respond within 24 hours! üî•',
        createdAt: '2026-01-01T10:00:00Z',
        updatedAt: '2026-01-02T10:00:00Z'
      },
      'note_2': {
        pattern: '@spam.com',
        matchType: 'endsWith',
        note: '‚ö†Ô∏è Known spam domain - be careful!',
        createdAt: '2026-01-03T10:00:00Z',
        updatedAt: '2026-01-03T10:00:00Z'
      }
    };

    // Mock templates - stored in parent so changes persist across iframe reloads
    let mockTemplates = [
      "Important client - always respond within 24 hours! üî•",
      "VIP customer - handle with care ‚≠ê",
      "Potential spam - verify before responding ‚ö†Ô∏è",
      "Slow payer - request upfront payment üí∞",
      "Old colleague / friend üëã",
      "Newsletter - low priority üì∞"
    ];

    // Log function
    function log(action, data) {
      const logOutput = document.getElementById('log-output');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      const time = new Date().toLocaleTimeString();
      entry.innerHTML = `<span style="color:#888">[${time}]</span> <span style="color:#ffd700">${action}</span>: ${JSON.stringify(data).substring(0, 100)}`;
      logOutput.insertBefore(entry, logOutput.firstChild);
    }

    function clearLog() {
      document.getElementById('log-output').innerHTML = '';
    }

    // Helper: validate pattern against email
    function validatePattern(email, pattern, matchType) {
      const emailLower = email.toLowerCase();
      const patternLower = pattern.toLowerCase();
      
      switch (matchType) {
        case 'exact':
          return emailLower === patternLower;
        case 'startsWith':
          return emailLower.startsWith(patternLower);
        case 'endsWith':
          return emailLower.endsWith(patternLower);
        case 'contains':
          return emailLower.includes(patternLower);
        default:
          return false;
      }
    }

    // Helper: find matching note for email (priority order)
    function findMatchingNote(email) {
      const priorities = ['exact', 'startsWith', 'endsWith', 'contains'];
      
      for (const matchType of priorities) {
        for (const [id, noteData] of Object.entries(mockNotes)) {
          if (noteData.matchType === matchType && validatePattern(email, noteData.pattern, matchType)) {
            return { id, ...noteData };
          }
        }
      }
      return null;
    }

    // Helper: generate unique ID
    function generateId() {
      return 'note_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Create mock messenger API
    function createMockMessenger() {
      return {
        runtime: {
          sendMessage: async (message) => {
            log('sendMessage', message);
            
            switch (message.action) {
              case 'getNote':
                // Legacy support: if email provided, find matching note
                if (message.email) {
                  const match = findMatchingNote(message.email);
                  log('getNote result', match);
                  return match;
                }
                return null;

              case 'findMatchingNote':
                const match = findMatchingNote(message.email);
                log('findMatchingNote result', match);
                return match;

              case 'validatePattern':
                const isValid = validatePattern(message.email, message.pattern, message.matchType);
                log('validatePattern result', isValid);
                return { matches: isValid };

              case 'saveNote':
                const noteId = generateId();
                mockNotes[noteId] = {
                  pattern: message.pattern,
                  matchType: message.matchType,
                  note: message.note,
                  createdAt: new Date().toISOString(),
                  updatedAt: new Date().toISOString()
                };
                log('saveNote', { id: noteId, pattern: message.pattern, matchType: message.matchType });
                renderBanner(message.note);
                return { success: true, id: noteId };

              case 'deleteNote':
                if (message.id && mockNotes[message.id]) {
                  delete mockNotes[message.id];
                  log('deleteNote', message.id);
                  hideBanner();
                  return { success: true };
                }
                // Legacy: delete by email
                const toDelete = findMatchingNote(message.email);
                if (toDelete) {
                  delete mockNotes[toDelete.id];
                  log('deleteNote', toDelete.id);
                  hideBanner();
                  return { success: true };
                }
                return { success: false };

              case 'getCurrentMessageSender':
                return {
                  email: 'john.doe@example.com',
                  author: 'John Doe <john.doe@example.com>'
                };

              case 'getTemplates':
                log('getTemplates', mockTemplates.length + ' templates');
                return [...mockTemplates];

              case 'addTemplate':
                if (!mockTemplates.includes(message.template)) {
                  mockTemplates.push(message.template);
                  log('addTemplate', message.template);
                }
                return { success: true, templates: [...mockTemplates] };

              case 'deleteTemplate':
                if (message.index >= 0 && message.index < mockTemplates.length) {
                  const deleted = mockTemplates.splice(message.index, 1);
                  log('deleteTemplate', deleted[0]);
                }
                return { success: true, templates: [...mockTemplates] };

              default:
                log('unknown action', message.action);
                return null;
            }
          },
          onMessage: {
            addListener: () => {}
          }
        },
        windows: {
          create: async (options) => {
            log('windows.create', options.url);
            alert('Would open popup: ' + options.url);
          }
        },
        storage: {
          local: {
            get: async () => ({ notes: mockNotes, templates: mockTemplates }),
            set: async () => {}
          }
        }
      };
    }

    // Inject mock API into iframes
    function injectMockAPI(iframe) {
      iframe.onload = () => {
        try {
          iframe.contentWindow.messenger = createMockMessenger();
          iframe.contentWindow.close = () => {
            log('window.close', 'Popup closed');
          };
          // Also inject confirm for delete functionality
          iframe.contentWindow.confirm = (msg) => {
            log('confirm', msg);
            return window.confirm(msg);
          };
          log('API injected', iframe.id);
        } catch (e) {
          log('inject error', e.message);
        }
      };
    }

    function reloadFrames() {
      document.querySelectorAll('iframe').forEach(iframe => {
        iframe.src = iframe.src;
      });
      log('reloadFrames', 'All frames reloaded');
    }

    // Initialize iframes
    document.querySelectorAll('iframe').forEach(injectMockAPI);

    // Render banner
    function renderBanner(note) {
      const container = document.getElementById('banner-container');
      container.innerHTML = `
        <div style="
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 12px 16px;
          background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
          border-bottom: 2px solid #ffc107;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          font-size: 14px;
          color: #856404;
        ">
          <span style="font-size: 18px;">üìù</span>
          <span style="flex: 1; line-height: 1.4;">${note}</span>
          <button onclick="hideBanner()" style="
            background: transparent;
            border: none;
            font-size: 20px;
            color: #856404;
            cursor: pointer;
            padding: 0 4px;
            opacity: 0.7;
          ">√ó</button>
        </div>
      `;
    }

    function hideBanner() {
      document.getElementById('banner-container').innerHTML = '';
    }

    function toggleBanner() {
      const container = document.getElementById('banner-container');
      if (container.innerHTML) {
        hideBanner();
      } else {
        const match = findMatchingNote('john.doe@example.com');
        if (match) {
          renderBanner(match.note);
        } else {
          renderBanner('No note set for this sender');
        }
      }
    }

    function changeNote() {
      const randomNote = mockTemplates[Math.floor(Math.random() * mockTemplates.length)];
      const match = findMatchingNote('john.doe@example.com');
      if (match) {
        mockNotes[match.id].note = randomNote;
        mockNotes[match.id].updatedAt = new Date().toISOString();
      } else {
        mockNotes['note_random'] = {
          pattern: 'john.doe@example.com',
          matchType: 'exact',
          note: randomNote,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
      }
      renderBanner(randomNote);
      log('changeNote', randomNote);
    }

    // Initial render
    const initialMatch = findMatchingNote('john.doe@example.com');
    if (initialMatch) {
      renderBanner(initialMatch.note);
    }
    
    log('init', 'Preview loaded with pattern matching support');
  </script>
</body>
</html>
